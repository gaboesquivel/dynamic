---
description: Next.js development standards and patterns
globs: *.tsx,*.ts
alwaysApply: false
---

# Next.js Rules

## React Server Components (CRITICAL)

**ALWAYS default to Server Components. Only use `'use client'` when absolutely necessary.**

**When to Use Client Components (`'use client'`):**
- Interactive features: `onClick`, `onChange`, `onSubmit` handlers
- Browser APIs: `window`, `document`, `localStorage`, `navigator`
- React hooks: `useState`, `useEffect`, `useContext` (for client-side state)
- Third-party libraries requiring client-side execution
- Event listeners or real-time subscriptions

**Component Splitting Pattern:**
```tsx
// ✅ Server Component page
import { ClientInteractiveSection } from './client-interactive-section'

export default function Page() {
  const data = await fetchData()
  return (
    <div>
      <h1>{data.title}</h1>
      <ClientInteractiveSection initialData={data} />
    </div>
  )
}

// ✅ Client Component (only when needed)
'use client'
export function ClientInteractiveSection({ initialData }) {
  const [state, setState] = useState(initialData)
}
```

**Anti-Patterns:**
```tsx
// ❌ Unnecessary client component
'use client'
export default function Page() {
  return <div>Static content</div>
}

// ❌ Entire page as client when only small part needs interactivity
'use client'
export default function Page() {
  return (
    <div>
      <StaticHeader />
      <StaticContent />
      <InteractiveButton /> {/* Only this needs client */}
    </div>
  )
}
```

## Exports
- **Pages and Layouts**: Default exports required for `app/**/page.tsx` and `app/**/layout.tsx` (exception to named exports rule)
- **Components**: Named exports for all other components

## Environment Variables
See [Environment Rules](../base/environment.mdc) for pattern. Next.js automatically loads `.env` files.

**Validation Pattern:**
```tsx
import { z } from 'zod'
import { validateEnv } from '@vencura/lib'

const envSchema = z.object({
  NEXT_PUBLIC_DYNAMIC_ENVIRONMENT_ID: z.string().min(1).optional(),
})

export function validateAppEnv({ env = process.env }: { env?: NodeJS.ProcessEnv } = {}) {
  return validateEnv({ schema: envSchema, env })
}
```

## Server Actions
```tsx
'use server'
import { type ActionResult, success, failure } from '@repo/next'
import { createSafeActionClient } from 'next-safe-action'

export const saveAction = createSafeActionClient()
  .schema(actionSchema)
  .action(async ({ parsedInput }): Promise<ActionResult<T>> => {
    try {
      return success(result)
    } catch (error) {
      return failure({ code: 'UNEXPECTED_ERROR', error, label: 'saveAction' })
    }
  })
```

## Performance Optimization
- Implement streaming with `Suspense` for progressive loading
- Optimize Core Web Vitals (LCP < 2.5s, FID < 100ms, CLS < 0.1)
- Optimize images: WebP format, proper size data, lazy loading

## Related Rules
- [React Hooks Rules](./react-hooks.mdc) - TanStack Query patterns
- [React Rules](./react.mdc) - Component patterns
- [Environment Rules](../base/environment.mdc) - Environment variable patterns
- [TypeScript Rules](../base/typescript.mdc) - Code style guidelines
