---
description: Backend testing standards and patterns for NestJS
globs: *.spec.ts,**/*.e2e-spec.ts,**/*test.ts
alwaysApply: false
---

# Backend Testing Rules

## Testing Philosophy
**CRITICAL**: All tests use real APIs with real API keys. NO MOCKS allowed for core functionality.
- E2E tests hit real Dynamic SDK endpoints (no unit tests)
- Integration tests use real blockchain RPCs
- Tests run exclusively against Arbitrum Sepolia testnet (chain ID: 421614)
- Automated gas faucet funds wallets with minimum ETH required (calculated dynamically with 20% buffer)

## Test Structure
### E2E Tests (Blackbox API Testing)
- **Location**: `test/*.e2e-spec.ts`
- **Pattern**: Tests only interact with HTTP endpoints, not internal implementation
- **Real APIs**: All tests use real Dynamic SDK endpoints (no mocks)

## Test Coverage Requirements
**For endpoints only, never unit test in API:**
- Wallet Creation (EVM and Solana via Dynamic SDK)
- Balance Queries (both chain types)
- Message Signing (both chain types)
- Transaction Sending (with automated gas funding)
- Error Handling (all error cases and validation)
- User Isolation (users can only access their own wallets)
- Multichain Support (all supported chains)

## Jest Configuration
**All NestJS tests run in CommonJS mode** - Jest must be configured for CJS to test against built output:
- Tests run against built `dist/` output (CJS), not TypeScript source
- Test setup files import from `dist/` (e.g., `import { validateEnv } from '../dist/config/env.schema'`)
- Test setup files must use ESM patterns (replace `__dirname` with ESM equivalent)
