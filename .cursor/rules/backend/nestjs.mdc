---
description: NestJS backend development standards and patterns
globs: *.ts,**/*module.ts,**/*service.ts,**/*controller.ts
alwaysApply: false
---
# NestJS Rules

## Module Structure
- Organize code by domain/feature modules
- Keep modules focused and single-purpose

## API Design
- Use DTOs with class-validator for input validation
  - **DTOs (Data Transfer Objects)** in NestJS controllers should use `class-validator` decorators
  - This is the NestJS standard and exception to the zod preference
- Use zod for all other schemas (tool parameters, environment variables, internal validation)
- Document APIs with Swagger/OpenAPI

## Utility Libraries
- **@vencura/lib**: Shared utility library for common operations
  - **Error utilities**: Use `sanitizeErrorMessage` in exception filters for production error sanitization
  - **Async utilities**: Use `fetchWithTimeout` for external API calls (addresses security LOW-003)
  - **Error handling**: Use `getErrorMessage` to extract error messages consistently
  - Import from `@vencura/lib`: `import { sanitizeErrorMessage, fetchWithTimeout } from '@vencura/lib'`

## Database Access
- Use the repository pattern for database operations
- Use Drizzle for database interactions
- Optimize database queries for performance

## AI/Streaming Integration
- **@ai-sdk/core**: Use for provider-agnostic AI integration
  - Use `streamText` for streaming chat responses
  - Use `tool()` function for defining AI tools
  - Support both streaming and non-streaming modes
- **Server-Sent Events (SSE)**: Implement streaming responses
  - Use `@Res()` decorator with Express Response
  - Set proper headers: `Content-Type: text/event-stream`, `Cache-Control: no-cache`, `Connection: keep-alive`
  - Stream chunks with `data: {json}\n\n` format
  - End stream with `data: [DONE]\n\n`
- **Tool Definitions**: Expose API endpoints as AI tools
  - Use Zod schemas for tool parameters
  - Wrap existing service methods
  - Handle errors and return structured responses
  - Pass user context for authorization

## Testing
- Implement API testing, input output validation