---
description: NestJS backend development standards and patterns
globs: *.ts,**/*module.ts,**/*service.ts,**/*controller.ts
alwaysApply: false
---

# NestJS Rules

## Module Structure
- Organize by domain/feature modules
- Keep modules focused and single-purpose

## ESM Patterns
**Never use `__dirname` or `__filename`** - use ESM pattern:
```typescript
import { fileURLToPath } from 'node:url'
import { dirname } from 'node:path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
```

**Never use `require()`** - use dynamic `import()`:
```typescript
import { pathToFileURL } from 'node:url'
const moduleUrl = pathToFileURL(join(__dirname, '../dist/app.module.js')).href
const { AppModule } = await import(moduleUrl)
```

## API Design
- **DTOs use `class-validator`** (exception to zod preference for NestJS standard)
- Use zod for tool parameters, environment variables, and internal validation
- Document APIs with Swagger/OpenAPI

## Utility Libraries
- **@vencura/lib**: Use `sanitizeErrorMessage` in exception filters, `fetchWithTimeout` for external APIs, `getErrorMessage` for error extraction

## AI/Streaming Integration
- **@ai-sdk/core**: Use `streamText` for streaming, `tool()` for tool definitions
- **SSE format**: `data: {json}\n\n` chunks, end with `data: [DONE]\n\n`
- **Tool definitions**: Use Zod schemas, wrap service methods, pass user context

## Environment Variables
See [Environment Rules](../base/environment.mdc) for pattern. NestJS requires manual `loadEnv()` call before app initialization.
