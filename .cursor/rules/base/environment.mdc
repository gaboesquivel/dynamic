---
description: Environment variable management pattern for all apps
globs: .env*,**/env*.ts,**/load-env.ts
alwaysApply: false
---
# Environment Variable Pattern

**This pattern applies consistently across all apps in the stack** - Next.js frontend apps, NestJS API (`apps/api`), and other Node.js apps.

## File Structure

**Files:**
- `.env` - Sensitive data (API keys, tokens, secrets) - **NEVER COMMIT**
- `.env.development` / `.env.staging` / `.env.production` / `.env.test` - Non-sensitive configuration (committed)
- `.env-example` - Template for `.env` file (committed)

**Loading Priority (highest to lowest):**
1. `.env` (sensitive, never committed, overrides everything)
2. `.env.{environment}` (based on NODE_ENV, committed configs)

## Validation Pattern

**Always use Zod for environment variable validation** - consistent across all apps (Next.js, NestJS API, etc.).

- Define schema with `z.object()`
- Use `z.infer<typeof envSchema>` for type inference
- Validation functions must have explicit return types
- Next.js: Use `validateEnv` from `@vencura/lib`, handle warnings/errors based on NODE_ENV
- NestJS: Use `safeParse`, throw errors on validation failure
- NestJS requires manual `loadEnv()` call in app initialization

**load-env.ts (ESM):**
- Load `.env.{environment}` first (based on NODE_ENV)
- Load `.env` last (highest priority)
- Use `fileURLToPath` and `dirname` for ESM path resolution

## Key Principles

1. **Sensitive vs Non-Sensitive**: Clear separation - `.env` (sensitive, never commit) vs `.env.{environment}` (non-sensitive, committed)
2. **Zod Validation**: Always use Zod for runtime validation and type inference
3. **Type Safety**: Use `z.infer<typeof envSchema>` for type inference
4. **Explicit Return Types**: Validation functions must have explicit return types
5. **No Example Files**: Remove all `.env.{environment}.example` files - update `.env.{environment}` directly with values

## Git Configuration

**`.gitignore` should include `.env`** (never commit). `.env.{environment}` files are committed.
